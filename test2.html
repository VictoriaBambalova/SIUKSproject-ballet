<!doctype html>
<html lang="bg">
  <head>
    <meta charset="utf-8" />
    <title>Балет – Задача 1 (2D стъпала)</title>

    <script src="suica.js"></script>

    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        overflow: hidden;
        font-family: system-ui, Arial, sans-serif;
        touch-action: none; /* предотвратява скрол/gesture конфликт при drag */
      }

      #ui {
        position: fixed;
        left: 12px;
        top: 12px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 10px;
        padding: 10px 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        min-width: 260px;
      }

      #ui h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
      }

      .row {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin: 6px 0;
      }

      button {
        border: 1px solid rgba(0, 0, 0, 0.18);
        background: white;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 13px;
      }
      button:hover {
        background: #f3f3f3;
      }

      .hint {
        font-size: 12px;
        color: #333;
        margin-top: 8px;
        line-height: 1.3;
      }

      .small {
        font-size: 12px;
        color: #444;
        margin-top: 6px;
      }

      input[type="range"] {
        width: 100%;
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, 0.15);
        background: #fff;
      }
    </style>
  </head>

  <body>
    <!--
      2D учебно поле (orthographic camera) за упражнение:
      Ученикът пресъздава балетните позиции чрез влачене и въртене.
    -->
    <suica id="scene" fullwindow background="LavenderBlush">
      <!-- proactive гарантира регулярни обновявания при интеракция -->
      <proactive></proactive>
    </suica>

    <!--
      Контролен панел:
      - Бутони за пресети (шест позиции)
      - Слайдер за прецизно завъртане на избраното стъпало
    -->
    <div id="ui">
      <h3>Задача 1: Подреди стъпалата в балетните позиции</h3>

      <div class="row">
        <button onclick="setPose(1)">I</button>
        <button onclick="setPose(2)">II</button>
        <button onclick="setPose(3)">III</button>
        <button onclick="setPose(4)">IV</button>
        <button onclick="setPose(5)">V</button>
        <button onclick="setPose(6)">VI</button>
        <button onclick="resetFeet()">Reset</button>
      </div>

      <div class="small">
        Избрано стъпало: <span id="sel" class="badge">няма</span>
      </div>

      <div class="small" style="margin-top: 8px">Ъгъл (за избраното):</div>
      <input
        id="angleSlider"
        type="range"
        min="-180"
        max="180"
        value="0"
        step="1"
        oninput="sliderRotate(this.value)"
      />
      <div class="small">Angle: <span id="angleVal">0</span>°</div>

      <div class="hint">
        • Ляв бутон: влачи стъпалото<br />
        • Десен бутон + влачене: завъртай<br />
        • Shift при въртене: фиксация към 15°<br />
      </div>
    </div>

    <script>
      // =========================================================
      // 1) Настройка на 2D сцена
      // =========================================================
      fullWindow();
      orthographic(-1000, 1000);
      background("LavenderBlush");
      lookAt([0, 0, 300]); // камерата гледа към равнината на мрежата

      // =========================================================
      // 2) Параметри на учебната мрежа и модела на стъпало
      // =========================================================
      const SCALE = 30; // "полуклетка" в пиксели; използва се за лесно подравняване по мрежата
      const GRID_W = 700;
      const GRID_H = 450;

      // Модел на стъпало като композиция от 3 правоъгълника:
      // жълто = пръсти, синьо = стъпало, червено = пета (както е в предоставените схеми)
      // Забележка: цветовете са съобразени с визуалното изискване от задачата.
      const H = 3 * SCALE; // "ширина" на стъпалото по Y
      const L_TOE = 3 * SCALE;
      const L_MID = 7 * SCALE;
      const L_HEEL = 3 * SCALE;
      const TOTAL_L = L_TOE + L_MID + L_HEEL; // обща дължина по X

      // =========================================================
      // 3) Визуализация на квадратна мрежа
      // =========================================================
      const grid = group();
      grid.z = -5;

      for (let x = -GRID_W; x <= GRID_W; x += 2 * SCALE) {
        grid.add(line([x, -GRID_H, -5], [x, GRID_H, -5], "lightgray"));
      }
      for (let y = -GRID_H; y <= GRID_H; y += 2 * SCALE) {
        grid.add(line([-GRID_W, y, -5], [GRID_W, y, -5], "lightgray"));
      }

      // оси за ориентация
      grid.add(line([-GRID_W, 0, -4], [GRID_W, 0, -4], "gray"));
      grid.add(line([0, -GRID_H, -4], [0, GRID_H, -4], "gray"));

      // =========================================================
      // 4) Модел на "стъпало" (група от 3 правоъгълника + контур)
      // =========================================================
      function rectFillWithOutline(center, size, fillColor) {
        const fill = square(
          [center[0], center[1], -1],
          [size[0], size[1]],
          fillColor,
        );
        const border = square(
          [center[0], center[1], 0],
          [size[0], size[1]],
          "black",
        ).style({
          wireframe: true,
        });
        return group(fill, border);
      }

      function makeFoot() {
        const totalL = TOTAL_L;

        // локални центрове по X за трите сегмента
        const xToe = -totalL / 2 + L_TOE / 2;
        const xMid = xToe + L_TOE / 2 + L_MID / 2;
        const xHeel = xMid + L_MID / 2 + L_HEEL / 2;

        // Жълто = пръсти, Синьо = стъпало, Червено = пета
        const toe = rectFillWithOutline([xToe, 0, 0], [L_TOE, H], "#ffe066");
        const mid = rectFillWithOutline([xMid, 0, 0], [L_MID, H], "#00b4d8");
        const heel = rectFillWithOutline([xHeel, 0, 0], [L_HEEL, H], "#ff595e");

        const g = group(toe, mid, heel);

        // служебни данни за интерактивност
        g._angle = 0;
        g._parts = [toe, mid, heel];
        for (const p of g._parts) p._foot = g;

        return g;
      }

      const foot1 = makeFoot();
      const foot2 = makeFoot();
      const interactiveParts = [...foot1._parts, ...foot2._parts];

      // =========================================================
      // 5) UI избор на обект и прецизно въртене със слайдер
      // =========================================================
      let selectedFoot = null;

      function selectFoot(f) {
        selectedFoot = f;
        document.getElementById("sel").textContent =
          f === foot1 ? "ляво (Foot A)" : "дясно (Foot B)";
        document.getElementById("angleSlider").value = Math.round(f._angle);
        document.getElementById("angleVal").textContent = Math.round(f._angle);
      }

      window.sliderRotate = function (val) {
        if (!selectedFoot) return;
        const a = Number(val);
        selectedFoot._angle = a;
        selectedFoot.spinS = a;
        document.getElementById("angleVal").textContent = a;
      };

      // =========================================================
      // 6) Drag & Rotate интерактивност (основна цел на упражнението)
      // =========================================================
      function posXY(p) {
        // Suica може да върне позиция като масив [x,y,z] или като обект с x,y
        if (!p) return null;
        if (Array.isArray(p)) return { x: p[0], y: p[1] };
        if (typeof p.x === "number" && typeof p.y === "number")
          return { x: p.x, y: p.y };
        if (typeof p[0] === "number" && typeof p[1] === "number")
          return { x: p[0], y: p[1] };
        return null;
      }

      let dragFoot = null;
      let dragMode = null; // "move" | "rotate"
      let startMouse = { x: 0, y: 0 };
      let startAngle = 0;

      // десен бутон: спираме контекстното меню, за да се ползва за въртене
      window.addEventListener("contextmenu", (e) => e.preventDefault());

      function onPointerDown(event) {
        // клик върху панела не трябва да влияе на сцената
        if (event.target && event.target.closest && event.target.closest("#ui"))
          return;

        const part = findObject(event, interactiveParts);
        if (!part) return;

        const f = part._foot;
        if (!f) return;

        selectFoot(f);
        dragFoot = f;

        startMouse = { x: event.clientX, y: event.clientY };
        startAngle = dragFoot._angle;

        dragMode = event.button === 2 ? "rotate" : "move";
      }

      function onPointerUp() {
        dragFoot = null;
        dragMode = null;
      }

      function onPointerMove(event) {
        if (!dragFoot) return;

        if (dragMode === "move") {
          const raw = findPosition(event);
          const p = posXY(raw);
          if (!p) return;
          dragFoot.center = [p.x, p.y, 0];
        } else if (dragMode === "rotate") {
          const dx = event.clientX - startMouse.x;
          let a = startAngle + dx * 0.6;

          // по-лесна проверка на ъгли от ученика чрез фиксация към кратни на 15°
          if (event.shiftKey) a = 15 * Math.round(a / 15);

          dragFoot._angle = a;
          dragFoot.spinS = a;

          if (dragFoot === selectedFoot) {
            document.getElementById("angleSlider").value = Math.round(a);
            document.getElementById("angleVal").textContent = Math.round(a);
          }
        }
      }

      window.addEventListener("pointerdown", onPointerDown, { passive: false });
      window.addEventListener("pointermove", onPointerMove, { passive: false });
      window.addEventListener("pointerup", onPointerUp, { passive: false });

      // =========================================================
      // 7) Пресети (шест позиции) – целеви конфигурации за упражнението
      // =========================================================
      function setFoot(f, cx, cy, ang) {
        f.center = [cx, cy, 0];
        f._angle = ang;
        f.spinS = ang;
      }

      window.setPose = function (i) {
        const y0 = -2 * SCALE;

        if (i === 1) {
          // I позиция: стъпалата са долепени без застъпване.
          // За да няма overlap: разликата по X между центровете трябва да е точно TOTAL_L.
          setFoot(foot1, -TOTAL_L / 2, y0, 0);
          setFoot(foot2, TOTAL_L / 2, y0, 180);
        }

        if (i === 2) {
          // II позиция: по-широко раздалечени (оставям както беше).
          setFoot(foot1, -10 * SCALE, y0, 0);
          setFoot(foot2, 10 * SCALE, y0, 180);
        }

        if (i === 3) {
          // III позиция: връщане към предходната визия (диагонално стъпало),
          // като изискването е жълтото (пръстите) да е отгоре.
          // Това се постига с обръщане на 180° спрямо 45°, т.е. 225°.
          setFoot(foot1, -6 * SCALE, y0, 0);
          setFoot(foot2, 6 * SCALE, y0 + 5 * SCALE, 225);
        }

        if (i === 4) {
          // IV позиция: едно над друго, различават се само по Y.
          const xSame = 0;
          setFoot(foot1, xSame, y0 - 6 * SCALE, 0);
          setFoot(foot2, xSame, y0 + 6 * SCALE, 180);
        }

        if (i === 5) {
          // V позиция: като IV, но долепени по ръб (без разстояние).
          // Горният ръб на долното съвпада с долния ръб на горното:
          // yTop = yBottom + H.
          const xSame = 0;
          const yBottom = y0 - 2 * SCALE;
          const yTop = yBottom + H;

          setFoot(foot1, xSame, yBottom, 0);
          setFoot(foot2, xSame, yTop, 180);
        }

        if (i === 6) {
          // VI позиция: долепени по дългата си страна (по X),
          // с противоположна ориентация, без разстояние между тях.
          const ySame = y0;
          setFoot(foot1, -TOTAL_L / 2, ySame, 0);
          setFoot(foot2, TOTAL_L / 2, ySame, 180);
        }

        if (selectedFoot) selectFoot(selectedFoot);
      };

      window.resetFeet = function () {
        setFoot(foot1, -8 * SCALE, -4 * SCALE, 0);
        setFoot(foot2, 8 * SCALE, -4 * SCALE, 180);
        if (selectedFoot) selectFoot(selectedFoot);
      };

      // стартова демонстрация
      setPose(1);
    </script>
  </body>
</html>
