<!doctype html>
<html lang="bg">
  <head>
    <meta charset="utf-8" />
    <title>Балет – Задача 1 (2D стъпала)</title>

    <script src="suica.js"></script>

    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        overflow: hidden;
        font-family: system-ui, Arial, sans-serif;
        touch-action: none;
      }

      #ui {
        position: fixed;
        left: 12px;
        top: 12px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 10px;
        padding: 10px 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        min-width: 260px;
      }

      #ui h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
      }

      .row {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin: 6px 0;
      }

      button {
        border: 1px solid rgba(0, 0, 0, 0.18);
        background: white;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 13px;
      }
      button:hover {
        background: #f3f3f3;
      }

      .hint {
        font-size: 12px;
        color: #333;
        margin-top: 8px;
        line-height: 1.3;
      }

      .small {
        font-size: 12px;
        color: #444;
        margin-top: 6px;
      }

      input[type="range"] {
        width: 100%;
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, 0.15);
        background: #fff;
      }
    </style>
  </head>

  <body>
    <suica id="scene" fullwindow background="LavenderBlush">
      <proactive></proactive>
    </suica>

    <div id="ui">
      <h3>Задача 1: Подреди стъпалата в балетните позиции</h3>

      <div class="row">
        <button onclick="setPose(1)">I</button>
        <button onclick="setPose(2)">II</button>
        <button onclick="setPose(3)">III</button>
        <button onclick="setPose(4)">IV</button>
        <button onclick="setPose(5)">V</button>
        <button onclick="setPose(6)">VI</button>
        <button onclick="resetFeet()">Reset</button>
      </div>

      <div class="small">
        Избрано стъпало: <span id="sel" class="badge">няма</span>
      </div>

      <div class="small" style="margin-top: 8px">Ъгъл (за избраното):</div>
      <input
        id="angleSlider"
        type="range"
        min="-180"
        max="180"
        value="0"
        step="1"
        oninput="sliderRotate(this.value)"
      />
      <div class="small">Angle: <span id="angleVal">0</span>°</div>

      <div class="hint">
        • Ляв бутон: влачи стъпалото<br />
        • Десен бутон + влачене: завъртай<br />
        • Shift при въртене: snap към 15°<br />
      </div>
    </div>

    <script>
      fullWindow();
      orthographic(-1000, 1000);
      background("LavenderBlush");
      lookAt([0, 0, 300]);

      const SCALE = 30;
      const GRID_W = 700;
      const GRID_H = 450;

      const grid = group();
      grid.z = -5;

      for (let x = -GRID_W; x <= GRID_W; x += 2 * SCALE) {
        grid.add(line([x, -GRID_H, -5], [x, GRID_H, -5], "lightgray"));
      }
      for (let y = -GRID_H; y <= GRID_H; y += 2 * SCALE) {
        grid.add(line([-GRID_W, y, -5], [GRID_W, y, -5], "lightgray"));
      }

      grid.add(line([-GRID_W, 0, -4], [GRID_W, 0, -4], "gray"));
      grid.add(line([0, -GRID_H, -4], [0, GRID_H, -4], "gray"));

      function rectFillWithOutline(center, size, fillColor) {
        const fill = square(
          [center[0], center[1], -1],
          [size[0], size[1]],
          fillColor,
        );
        const border = square(
          [center[0], center[1], 0],
          [size[0], size[1]],
          "black",
        ).style({
          wireframe: true,
        });
        return group(fill, border);
      }

      function makeFoot() {
        const H = 3 * SCALE;
        const L_HEEL = 3 * SCALE;
        const L_MID = 7 * SCALE;
        const L_TOE = 3 * SCALE;

        const totalL = L_HEEL + L_MID + L_TOE;

        const xHeel = -totalL / 2 + L_HEEL / 2;
        const xMid = xHeel + L_HEEL / 2 + L_MID / 2;
        const xToe = xMid + L_MID / 2 + L_TOE / 2;

        const heel = rectFillWithOutline([xHeel, 0, 0], [L_HEEL, H], "#ffe066");
        const mid = rectFillWithOutline([xMid, 0, 0], [L_MID, H], "#00b4d8");
        const toe = rectFillWithOutline([xToe, 0, 0], [L_TOE, H], "#ff595e");

        const g = group(heel, mid, toe);
        g._angle = 0;
        g._parts = [heel, mid, toe];
        for (const p of g._parts) p._foot = g;
        return g;
      }

      const foot1 = makeFoot();
      const foot2 = makeFoot();
      const interactiveParts = [...foot1._parts, ...foot2._parts];

      let selectedFoot = null;
      function selectFoot(f) {
        selectedFoot = f;
        document.getElementById("sel").textContent =
          f === foot1 ? "ляво (Foot A)" : "дясно (Foot B)";
        document.getElementById("angleSlider").value = Math.round(f._angle);
        document.getElementById("angleVal").textContent = Math.round(f._angle);
      }

      window.sliderRotate = function (val) {
        if (!selectedFoot) return;
        const a = Number(val);
        selectedFoot._angle = a;
        selectedFoot.spinS = a;
        document.getElementById("angleVal").textContent = a;
      };

      // ✅ helper: нормализира позицията от findPosition към {x,y}
      function posXY(p) {
        if (!p) return null;
        if (Array.isArray(p)) return { x: p[0], y: p[1] };
        if (typeof p.x === "number" && typeof p.y === "number")
          return { x: p.x, y: p.y };
        // понякога може да върне обект като vector с индексни полета
        if (typeof p[0] === "number" && typeof p[1] === "number")
          return { x: p[0], y: p[1] };
        return null;
      }

      let dragFoot = null;
      let dragMode = null;
      let startMouse = { x: 0, y: 0 };
      let startAngle = 0;

      window.addEventListener("contextmenu", (e) => e.preventDefault());

      function onPointerDown(event) {
        if (event.target && event.target.closest && event.target.closest("#ui"))
          return;

        const part = findObject(event, interactiveParts);
        if (!part) return;

        const f = part._foot;
        if (!f) return;

        selectFoot(f);
        dragFoot = f;
        startMouse = { x: event.clientX, y: event.clientY };
        startAngle = dragFoot._angle;
        dragMode = event.button === 2 ? "rotate" : "move";
      }

      function onPointerUp(event) {
        dragFoot = null;
        dragMode = null;
      }

      function onPointerMove(event) {
        if (!dragFoot) return;

        if (dragMode === "move") {
          const raw = findPosition(event);
          const p = posXY(raw);
          if (!p) return; // ако не може да се прочете позиция – нищо не правим
          dragFoot.center = [p.x, p.y, 0];
        } else if (dragMode === "rotate") {
          const dx = event.clientX - startMouse.x;
          let a = startAngle + dx * 0.6;
          if (event.shiftKey) a = 15 * Math.round(a / 15);

          dragFoot._angle = a;
          dragFoot.spinS = a;

          if (dragFoot === selectedFoot) {
            document.getElementById("angleSlider").value = Math.round(a);
            document.getElementById("angleVal").textContent = Math.round(a);
          }
        }
      }

      window.addEventListener("pointerdown", onPointerDown, { passive: false });
      window.addEventListener("pointermove", onPointerMove, { passive: false });
      window.addEventListener("pointerup", onPointerUp, { passive: false });

      function setFoot(f, cx, cy, ang) {
        f.center = [cx, cy, 0];
        f._angle = ang;
        f.spinS = ang;
      }

      window.setPose = function (i) {
        const y0 = -2 * SCALE;

        if (i === 1) {
          setFoot(foot1, -5 * SCALE, y0, 0);
          setFoot(foot2, 5 * SCALE, y0, 180);
        }
        if (i === 2) {
          setFoot(foot1, -10 * SCALE, y0, 0);
          setFoot(foot2, 10 * SCALE, y0, 180);
        }
        if (i === 3) {
          setFoot(foot1, -5 * SCALE, y0 - 2 * SCALE, 0);
          setFoot(foot2, 3 * SCALE, y0 + 6 * SCALE, 135);
        }
        if (i === 4) {
          setFoot(foot1, -5 * SCALE, y0 - 5 * SCALE, 0);
          setFoot(foot2, 5 * SCALE, y0 + 5 * SCALE, 180);
        }
        if (i === 5) {
          setFoot(foot1, 0, y0 - 4 * SCALE, 0);
          setFoot(foot2, 0, y0 + 4 * SCALE, 180);
        }
        if (i === 6) {
          setFoot(foot1, -2 * SCALE, y0, 90);
          setFoot(foot2, 2 * SCALE, y0, 90);
        }

        if (selectedFoot) selectFoot(selectedFoot);
      };

      window.resetFeet = function () {
        setFoot(foot1, -8 * SCALE, -4 * SCALE, 0);
        setFoot(foot2, 8 * SCALE, -4 * SCALE, 180);
        if (selectedFoot) selectFoot(selectedFoot);
      };

      // старт
      setPose(1);
    </script>
  </body>
</html>
